parameters:
  - name: 'pool'
    default: ''

  - name: 'source_env'
    default: ''
  - name: 'target_env'
    default: ''
  - name: 'target_storageaccount'
    default: ''

  - name: 'lang'
    default: ''

stages:
  - stage: alMergeFrom${{ parameters.source_env }}
    displayName: 'Active Learning Merge for ${{ parameters.lang }} from ${{ parameters.source_env }} to ${{ parameters.target_env }} '
    jobs:
    - job: alDownload
      displayName: 'Download and Publish Active Learning from ${{ parameters.source_env }}'
      pool: ${{ parameters.pool }}
      steps:

      # Prepare Python and retrieve Config Values
      - template: ../python-job-prep.template.yml
        parameters:
          lang: ${{ parameters.lang }}

      # Additional configuration for uploadArtifact
      - script: |
          LANG_UPPER=$(echo ${{ parameters.lang }} | tr [:lower:] [:upper:])
          ARTIFACT_NAME="AL_${LANG_UPPER}_$(Build.BuildNumber)_${{ parameters.source_env }}"
          echo "##vso[task.setvariable variable=ARTIFACT_NAME;isOutput=true]$ARTIFACT_NAME"
        name: addConfig
        displayName: 'Additional Configuration'

      # Download KB from current Environment associated to 'pool'
      - script: |
          python kb/scripts/download-kb.py --output ${{ parameters.source_env }}.json --slot Test
        displayName: 'Download KB'
        workingDirectory: $(System.DefaultWorkingDirectory)
        env:
          PYTHONPATH: $(System.DefaultWorkingDirectory)
          QNA_SOURCE_ENDPOINT: $(QNA_PROD_ENDPOINT_HOST)
          QNA_SOURCE_SUB_KEY: $(QNA_PROD_ENDPOINT_KEY)
          QNA_SOURCE_KB_ID: $(QNA_PROD_KB_ID)

      # Create Azure DevOps Artifact
      - publish: ${{ parameters.source_env }}.json
        artifact: $(addConfig.ARTIFACT_NAME)

    - job: alMerge
      dependsOn: alDownload
      displayName: 'Merge to ${{ parameters.target_env }}'
      pool: ${{ parameters.pool }}
      steps:
      # Download artifact
      - download: current

      # Additional configuration
      - script: |
          LANG_UPPER=$(echo ${{ parameters.lang }} | tr [:lower:] [:upper:])
          ARTIFACT_NAME="AL_${LANG_UPPER}_$(Build.BuildNumber)_${{ parameters.source_env }}"
          echo "##vso[task.setvariable variable=ARTIFACT_NAME;isOutput=true]$ARTIFACT_NAME"
          STORAGE_FOLDER_NAME="AL_${LANG_UPPER}_$(Build.BuildNumber)"
          echo "##vso[task.setvariable variable=STORAGE_FOLDER_NAME;isOutput=true]$STORAGE_FOLDER_NAME"
        name: addConfig
        displayName: 'Additional Configuration'

      # Prepare Python and retrieve Config Values
      - template: ../python-job-prep.template.yml
        parameters:
          lang: ${{ parameters.lang }}
      
      # Merging Feedback from Target to Source
      - script: |
          ls $(Pipeline.Workspace)/$(addConfig.ARTIFACT_NAME)
          python kb/scripts/merge-kb.py --input $(Pipeline.Workspace)/$(addConfig.ARTIFACT_NAME)/${{ parameters.source_env }}.json
        displayName: 'Merge Active Learning to ${{ parameters.target_env }}'
        workingDirectory: $(System.DefaultWorkingDirectory)
        env:
          PYTHONPATH: $(System.DefaultWorkingDirectory)
          QNA_DEST_ENDPOINT: $(QNA_EDIT_ENDPOINT_HOST)
          QNA_DEST_SUB_KEY: $(QNA_EDIT_ENDPOINT_KEY)
          QNA_DEST_KB_ID: $(QNA_EDIT_KB_ID)

      # Upload KB to Storage
      - script: |
          az storage blob upload --container-name mlops \
                          --file $(Pipeline.Workspace)/$(addConfig.ARTIFACT_NAME)/${{ parameters.source_env }}.json \
                          --name $(addConfig.STORAGE_FOLDER_NAME)/${{ parameters.source_env }}.json \
                          --account-name ${{ parameters.target_storageaccount }} \
                          --sas-token
        displayName: 'Upload to Azure Storage on ${{ parameters.target_env }}'
        enabled: false  #################
        env:
          AZURE_STORAGE_SAS_TOKEN: $(AZURE_STORAGE_SAS_TOKEN)